<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



















  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="https://fonts.google.com/specimen/Roboto?selection.family=Roboto/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="http://cloud.css0209.cn/css0209img/logo.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本篇文章以四川航天职业技术学院教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：[mdx_github author=”idoctype” project=”zhengfang”][/mdx_github] 首先观察学校官网的地址：  原本的地址是 http://220.167.53.63:95/ 然后变成 http://220.167.53.63:95/(4eg">
<meta property="og:type" content="article">
<meta property="og:title" content="Python3 正方爬虫">
<meta property="og:url" content="http://css0209.cn/2018/08/11/103/index.html">
<meta property="og:site_name" content="BlankYk Blog">
<meta property="og:description" content="本篇文章以四川航天职业技术学院教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：[mdx_github author=”idoctype” project=”zhengfang”][/mdx_github] 首先观察学校官网的地址：  原本的地址是 http://220.167.53.63:95/ 然后变成 http://220.167.53.63:95/(4eg">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg">
<meta property="og:image" content="http://cloud.css0209.cn/2018/08/8FF2E09F-E9C7-44AC-980E-204355B34118.jpg">
<meta property="og:image" content="http://cloud.css0209.cn/2018/08/F138B3AB-E6F8-4FFA-92F5-29F5C9744776.jpg">
<meta property="og:image" content="http://cloud.css0209.cn/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618.jpg">
<meta property="og:image" content="http://www.css0209.cn/wp-content/uploads/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145.jpg">
<meta property="og:image" content="http://cloud.css0209.cn/2018/08/F0696265-FDA9-49E9-A2EA-D9B041B8687E.jpg">
<meta property="og:image" content="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-183454.png">
<meta property="og:image" content="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-183734.png">
<meta property="og:image" content="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-204015.png">
<meta property="og:updated_time" content="2018-09-14T21:09:16.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Python3 正方爬虫">
<meta name="twitter:description" content="本篇文章以四川航天职业技术学院教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：[mdx_github author=”idoctype” project=”zhengfang”][/mdx_github] 首先观察学校官网的地址：  原本的地址是 http://220.167.53.63:95/ 然后变成 http://220.167.53.63:95/(4eg">
<meta name="twitter:image" content="http://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg">






  <link rel="canonical" href="http://css0209.cn/2018/08/11/103/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Python3 正方爬虫 | BlankYk Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/idoctype" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; z-index: 10; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">BlankYk Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Blog</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />时间线</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-link">
    <a href="/links/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user-friends"></i> <br />link</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://css0209.cn/2018/08/11/103/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="BlankYK">
      <meta itemprop="description" content="世界上只有2种人，会二进制的和不会二进制的">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="BlankYk Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Python3 正方爬虫
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-08-11 19:52:13" itemprop="dateCreated datePublished" datetime="2018-08-11T19:52:13+08:00">2018-08-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-15 05:09:16" itemprop="dateModified" datetime="2018-09-15T05:09:16+08:00">2018-09-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/未分类/" itemprop="url" rel="index"><span itemprop="name">未分类</span></a></span>

                
                
              
            </span>
          

          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="本篇文章以四川航天职业技术学院教务系统为例"><a href="#本篇文章以四川航天职业技术学院教务系统为例" class="headerlink" title="本篇文章以四川航天职业技术学院教务系统为例"></a>本篇文章以四川航天职业技术学院教务系统为例</h2><p>由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：[mdx_github author=”idoctype” project=”zhengfang”][/mdx_github] 首先观察学校官网的地址： <a href="http://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg" target="_blank" rel="noopener"><img src="http://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg" alt=""></a> 原本的地址是 <a href="http://220.167.53.63:95/" target="_blank" rel="noopener">http://220.167.53.63:95/</a> 然后变成 <a href="http://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx" target="_blank" rel="noopener">http://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx</a> 首先端口使用的95端口，95端口是非安全端口，现在的主流浏览器应该是无法访问的，这里我只提供要用到的Chrome的Mac版的解决方案,具体可以参考我的文章 <a href="https://css0209.cn/2018/09/10/251/">Chrome/Firefox非安全端口问题</a> 打开终端复制以下命令，最后的<code>--explicitly-allowed-ports=95</code>中的95就是你想打开的非安全端口号</p>
<p>/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome –explicitly-allowed-ports=95 </p>
<p>然后是<code>(4eggunep4b4jhzfwhk4pva21)</code>中间的这窜数字，刷新几次后发现这个是会变的，也就是不确定的 default2.aspx是登录页面 再来看看NetWork的信息 <a href="http://cloud.css0209.cn/2018/08/8FF2E09F-E9C7-44AC-980E-204355B34118.jpg" target="_blank" rel="noopener"><img src="http://cloud.css0209.cn/2018/08/8FF2E09F-E9C7-44AC-980E-204355B34118.jpg" alt=""></a> 在我们访问<a href="http://220.167.53.63:95/时进行了以个302跳转，那么在302跳转之前是个什么东西呢？" target="_blank" rel="noopener">http://220.167.53.63:95/时进行了以个302跳转，那么在302跳转之前是个什么东西呢？</a> 我用Burp Suite Professional抓包工具来看看：  <a href="http://cloud.css0209.cn/2018/08/F138B3AB-E6F8-4FFA-92F5-29F5C9744776.jpg" target="_blank" rel="noopener"><img src="http://cloud.css0209.cn/2018/08/F138B3AB-E6F8-4FFA-92F5-29F5C9744776.jpg" alt=""></a> 得到上图中的信息然后我们可以发现<code>(bfpyl355aa3owdf50bdgfg55)</code>正好是我们需要的那段随机生成的值，也就是说，我们可以通过先爬取这个页面中的内容获得这个值，我们将这个值命名为token，然后代码如下： （由于这个博客的编辑器比较皮，所以格式可能有点不对，没法输制表符）</p>
<p># -<em>- coding: UTF-8 -</em>-<br>import urllib.parse<br>import requests<br>import re<br>import PIL<br>from PIL import Image<br>from bs4 import BeautifulSoup</p>
<p>session = requests.Session() # 初始化session</p>
<p>class ZF:<br># 初始化<br>         def __init__(self):<br>               self.url = ‘<a href="http://220.167.53.63:95/&#39;" target="_blank" rel="noopener">http://220.167.53.63:95/&#39;</a> # 链接<br>               s = session.get(‘{}default2.aspx’.format(self.url),allow_redirects=False) # allow_redirects:重定向；会话，get方法获取页面，防止302重定向<br>               pattern = re.compile(“href=’/\((\w*)\)”) # 正则表达式<br>               token = pattern.findall(s.text) # 查询页面中信息，匹配正则表达式并保存到列表token<br>               self.token = token[0] # 取出列表中的token,并赋值<br>               self.index_url = “<a href="http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)" target="_blank" rel="noopener">http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)</a> # 定义主页地址 </p>
<p>接下来我们登录观察并获取信息： <a href="http://www.css0209.cn/wp-content/uploads/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618-300x169.jpg" target="_blank" rel="noopener"></a><a href="http://cloud.css0209.cn/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618-300x169.jpg" target="_blank" rel="noopener"><img src="http://cloud.css0209.cn/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618.jpg" alt=""></a> 通过观察发现url地址的<code>defult2.aspx</code>变成了<code>xs_main.aspx?xh=[学号]</code> 提交的表单信息中有6个值</p>
<p>__VIEWSTATE</p>
<p>不知道是什么东西，但是会变，猜测和csrf类似</p>
<p>TextBox1</p>
<p>学号</p>
<p>TextBox2</p>
<p>密码</p>
<p>TextBox3</p>
<p>验证码</p>
<p>RadioButtonList1</p>
<p>登录页面学生的那个选框</p>
<p>Button1</p>
<p>永远都是空白</p>
<p>学号，密码，可以通过用户输入得到 Button1,和RadioButtonList1的值是固定的，而且RadioButtonList1如果在表单中不存在就会默认为学生选项 也就是说我们只需要解决验证码和__VIEWSTATE的值</p>
<h3 id="VIEWSTATE"><a href="#VIEWSTATE" class="headerlink" title="__VIEWSTATE"></a>__VIEWSTATE</h3><p>回到登录页面观察form表单 <a href="http://www.css0209.cn/wp-content/uploads/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145-300x163.jpg" target="_blank" rel="noopener"></a><a href="http://www.css0209.cn/wp-content/uploads/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145-300x163.jpg" target="_blank" rel="noopener"><img src="http://www.css0209.cn/wp-content/uploads/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145.jpg" alt=""></a> 很快便可以发现在form标签后面紧跟了一个input标签里面的value就是我们要的__VIEWSTATE的值 那么代码如下:</p>
<p># -<em>- coding: UTF-8 -</em>-<br>import urllib.parse<br>import requests<br>import re<br>import PIL<br>from PIL import Image<br>from bs4 import BeautifulSoup</p>
<p>session = requests.Session()  # 初始化session</p>
<p>class ZF:</p>
<pre><code># 初始化
def \_\_init\_\_(self):
    self.url = &apos;http://220.167.53.63:95/&apos;  # 链接
    s = session.get(&apos;{}default2.aspx&apos;.format(self.url),
                    allow\_redirects=False)  # allow\_redirects:重定向；会话，get方法获取页面，防止302重定向
    pattern = re.compile(&quot;href=&apos;/\\((\\w*)\\)&quot;)  # 正则表达式
    token = pattern.findall(s.text)  # 查询页面中信息，匹配正则表达式并保存到列表token
    self.token = token\[0\]  # 取出列表中的token,并赋值
    self.index_url = &quot;http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)  # 定义主页地址
    # requests过去页面信息
    r = requests.get(self.index_url)
    r.encoding = r.apparent_encoding
    # beautifulsoup格式化内容，用lxml解析
    soup = BeautifulSoup(r.text, &apos;lxml&apos;)
    # 从页面中获取__VIEWSTATE
    self.\_\_VIEWSTATE = soup.select\_one(&apos;input\[name=&quot;__VIEWSTATE&quot;\]&apos;).get(&quot;value&quot;)
    # 学号和密码
    # self.user = &apos;&apos;
    # self.pwd = &apos;&apos;
    self.user = input(&quot;请输入学号：&quot;)
    self.pwd = input(&quot;请输入密码：&quot;) 
</code></pre><h3 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h3><p>验证码获取很简单: 直接鼠标右键复制图片链接，复制下来会发现就是<code>default2.aspx</code>变成了<code>CheckCode.aspx</code> <img src="http://cloud.css0209.cn/2018/08/F0696265-FDA9-49E9-A2EA-D9B041B8687E.jpg" alt=""> 那么我们只需要把验证码以二进制的形式下载下来，需要的时候调用，能打开显示就行 代码如下:</p>
<h1 id="获取验证码图片并保存至本地，再打开"><a href="#获取验证码图片并保存至本地，再打开" class="headerlink" title="获取验证码图片并保存至本地，再打开"></a>获取验证码图片并保存至本地，再打开</h1><pre><code>def captchas(self):
    try:
        url = &quot;http://220.167.53.63:95/({})/CheckCode.aspx&quot;.format(self.token)  # 验证码图片地址
        img_r = requests.get(url)  # 获取验证码图片
        # 以二进制保存至本地
        with open(&apos;./img/captcha.jpg&apos;, &apos;wb&apos;) as f:
            f.write(img_r.content)
        # 利用PIL打开图片
        PIL.Image.open(&apos;./img/captcha.jpg&apos;).show()
        # 让用户输入验证码
        return input(&quot;请输入验证码：&quot;)
    except:
        print(&quot;error:获取验证码失败&quot;) 
</code></pre><p>获取了需要的信息，我们就可以进行模拟登陆了，这里我们登录后获取一下用户姓名并URL化，后面会用到:</p>
<h1 id="模拟登陆"><a href="#模拟登陆" class="headerlink" title="模拟登陆"></a>模拟登陆</h1><pre><code>def login(self):
    # http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xs_main.aspx?xh=\[学号\]
    try:

        url = &quot;http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)  # 生成登陆地址
        # 用字典保存data
        data = {
            &apos;\_\_VIEWSTATE&apos;: self.\_\_VIEWSTATE,
            &apos;TextBox1&apos;: self.user,
            &apos;TextBox2&apos;: self.pwd,
            &apos;TextBox3&apos;: self.captchas(),
            &apos;Button1&apos;: &apos;&apos;
        }
        r = session.post(url, data=data)
        r.encoding = r.apparent_encoding  # 修改编码为网页编码
        # 检查提交后URL中是否含有&apos;xs_main.aspx?xh=&apos;，如果有就表示登陆成功
        if &apos;xs_main.aspx?xh=&apos; in r.url:
            soup = BeautifulSoup(r.text, &apos;lxml&apos;)
            print(&apos;登陆成功\\n欢迎您：&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)
            # 获取姓名
            name = re.sub(&apos;同学&apos;, &apos;&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)
            # 将姓名URL化
            xm = urllib.parse.quote(name)
            return xm
        else:
            print(&apos;登陆失败&apos;, r.url)
    except:
        print(&quot;error:登录出错&quot;) 
</code></pre><p>接下来进行一次查询操作 <img src="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-183454.png" alt=""> 可以看到这个东西  <a href="http://220.167.53.63:95/(xg1yk155oifue555urpnb0ng)/xscjcx.aspx?xh=\[学号\]&amp;xm=\[URL化的姓名\]&amp;gnmkdm=N121605" target="_blank" rel="noopener">http://220.167.53.63:95/(xg1yk155oifue555urpnb0ng)/xscjcx.aspx?xh=\[学号\]&amp;xm=\[URL化的姓名\]&amp;gnmkdm=N121605</a> 这个地址是声明我们从哪里来的，我们可以由拼接生成</p>
<h1 id="获取URL化后的姓名"><a href="#获取URL化后的姓名" class="headerlink" title="获取URL化后的姓名"></a>获取URL化后的姓名</h1><pre><code>name = self.login()#这里是刚刚获取的URL话的名字
grade_url = &quot;{}({})/xscjcx.aspx?xh={}&amp;xm={}&amp;gnmkdm=N121605&quot;.format(self.url, self.token, self.user, name)  # 生成URL 
</code></pre><p>我们要把这个写入headers，这里要注意的是这个headers里Referer是一定要有的</p>
<p> header = {<br>                “Referer”: grade_url,  # Referer必须有<br>                “User-Agent”: “Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36”<br>            }  # 生成header </p>
<p>再来看下我们提交的东西 <img src="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-183734.png" alt=""> 这一看，妈哟！这么长的什么东西！？ 不要慌，回到之前页面看看 从表单那可以看到这么些东西 <img src="http://www.css0209.cn/wp-content/uploads/2018/08/QQ20180812-204015.png" alt="">   可以发现这些值就是我们需要的，那么爬取下来即可</p>
<p> r = requests.get(grade_url, headers=header)<br>            r.encoding = r.apparent_encoding<br>            “””<br>            r = requests.get(“{}/{}/xscjcx.aspx?{}”.format(self.url, self.token, urllib.parse.urlencode({<br>                ‘xh’: self.user,<br>                ‘xm’: info[2],<br>                ‘gnmkdm’: ‘N121603’<br>            })))<br>            “””<br>            soup = BeautifulSoup(r.text, ‘lxml’)</p>
<pre><code># 获取表单信息
\_\_EVENTTARGET = soup.select\_one(&apos;input\[name=&quot;__EVENTTARGET&quot;\]&apos;).get(&quot;value&quot;)
\_\_EVENTARGUMENT = soup.select\_one(&apos;input\[name=&quot;__EVENTARGUMENT&quot;\]&apos;).get(&quot;value&quot;)
new\_\_VIEWSTATE = soup.select\_one(&apos;input\[name=&quot;__VIEWSTATE&quot;\]&apos;).get(&quot;value&quot;) 
</code></pre><p>那么还有4个值</p>
<p>ddlXN</p>
<p>表单中的学年</p>
<p>ddlXQ</p>
<p>表单中的学期</p>
<p>ddl_kcxz</p>
<p>表单中的课程性质</p>
<p>btn_xq</p>
<p>点击的哪个按钮，这里我默认用学期成绩按钮</p>
<p>这里的<code>ddlXN</code>和<code>ddlXQ</code>我们让用户来输入 <code>ddl_kcxz</code>设为空和<code>btn_xq</code>为URL化的“学期成绩” 把表单信息存入data</p>
<p> grade_data = {<br>                “__EVENTTARGET”: __EVENTTARGET,<br>                “__EVENTARGUMENT”: __EVENTARGUMENT,<br>                “__VIEWSTATE”: new__VIEWSTATE,<br>                “ddlXN”: input(“请输入学年(如：2017-2018):”),<br>                “ddlXQ”: input(“请输入学期(如：1):”),<br>                “ddl_kcxz”: “”,<br>                “btn_xq”: urllib.parse.quote(“学期成绩”)<br>            } </p>
<p>有了信息后我们进行访问，会获得一些信息,然后我们将这些信息提取出来,然后写入HTML文档里</p>
<p> grade_html = session.post(grade_url, headers=header, data=grade_data)<br>            soup_grade = BeautifulSoup(grade_html.text, ‘lxml’)<br>            title = soup_grade.select(‘font[size=”4”]‘)[0].text  # 标题<br>            xh = soup_grade.select_one(‘span#lbl_xh’).text  # 学号<br>            xm = soup_grade.select_one(‘span#lbl_xm’).text  # 姓名<br>            xy = soup_grade.select_one(‘span#lbl_xy’).text  # 学院<br>            zy = ‘专业：{}’.format(soup_grade.select_one(‘span#lbl_zymc’).text)  # 专业<br>            xzb = soup_grade.select_one(‘span#lbl_xzb’).text  # 行政班<br>            table = soup_grade.select_one(‘table#Datagrid1’).prettify()  # 成绩表<br>            grade_table = re.sub(‘“datelist”‘, ‘“mdui-table”‘, table)<br>            grade = title + “<br>“ + xh + “<br>“ + xm + “<br>“ + xy + “<br>“ + zy + “<br>“ + xzb + “<br>“ + grade_table<br>            html = ‘’’&lt;!doctype html&gt; </p>
<pre><code>&apos;&apos;&apos;.format(urllib.parse.unquote(name))
    # 将内容写入html文件
    with open(&apos;./index.html&apos;, &apos;a+&apos;) as f:
        f.truncate(0)
        f.write(html + grade)
    print(&quot;it&apos;s done!&quot;)
except:
    print(&quot;error:获取成绩单出错&quot;) 
</code></pre><p>最后，来看一下整体代码</p>
<p># -<em>- coding: UTF-8 -</em>-<br>import urllib.parse<br>import requests<br>import re<br>import PIL<br>from PIL import Image<br>from bs4 import BeautifulSoup</p>
<p>session = requests.Session()  # 初始化session</p>
<p>class ZF:</p>
<pre><code># 初始化
def \_\_init\_\_(self):
    self.url = &apos;http://220.167.53.63:95/&apos;  # 链接
    s = session.get(&apos;{}default2.aspx&apos;.format(self.url),
                    allow\_redirects=False)  # allow\_redirects:重定向；会话，get方法获取页面，防止302重定向
    pattern = re.compile(&quot;href=&apos;/\\((\\w*)\\)&quot;)  # 正则表达式
    token = pattern.findall(s.text)  # 查询页面中信息，匹配正则表达式并保存到列表token
    self.token = token\[0\]  # 取出列表中的token,并赋值
    self.index_url = &quot;http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)  # 定义主页地址
    # requests过去页面信息
    r = requests.get(self.index_url)
    r.encoding = r.apparent_encoding
    # beautifulsoup格式化内容，用lxml解析
    soup = BeautifulSoup(r.text, &apos;lxml&apos;)
    # 从页面中获取__VIEWSTATE
    self.\_\_VIEWSTATE = soup.select\_one(&apos;input\[name=&quot;__VIEWSTATE&quot;\]&apos;).get(&quot;value&quot;)
    # 学号和密码
    # self.user = &apos;&apos;
    # self.pwd = &apos;&apos;
    self.user = input(&quot;请输入学号：&quot;)
    self.pwd = input(&quot;请输入密码：&quot;)

# 获取验证码图片并保存至本地，再打开
def captchas(self):
    try:
        url = &quot;http://220.167.53.63:95/({})/CheckCode.aspx&quot;.format(self.token)  # 验证码图片地址
        img_r = requests.get(url)  # 获取验证码图片
        # 以二进制保存至本地
        with open(&apos;./img/captcha.jpg&apos;, &apos;wb&apos;) as f:
            f.write(img_r.content)
        # 利用PIL打开图片
        PIL.Image.open(&apos;./img/captcha.jpg&apos;).show()
        # 让用户输入验证码
        return input(&quot;请输入验证码：&quot;)
    except:
        print(&quot;error:获取验证码失败&quot;)

# 模拟登陆
def login(self):
    # http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xs_main.aspx?xh=201713013059
    try:

        url = &quot;http://220.167.53.63:95/({})/default2.aspx&quot;.format(self.token)  # 生成登陆地址
        # 用字典保存data
        data = {
            &apos;\_\_VIEWSTATE&apos;: self.\_\_VIEWSTATE,
            &apos;TextBox1&apos;: self.user,
            &apos;TextBox2&apos;: self.pwd,
            &apos;TextBox3&apos;: self.captchas(),
            &apos;Button1&apos;: &apos;&apos;
        }
        r = session.post(url, data=data)
        r.encoding = r.apparent_encoding  # 修改编码为网页编码
        # 检查提交后URL中是否含有&apos;xs_main.aspx?xh=&apos;，如果有就表示登陆成功
        if &apos;xs_main.aspx?xh=&apos; in r.url:
            soup = BeautifulSoup(r.text, &apos;lxml&apos;)
            print(&apos;登陆成功\\n欢迎您：&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)
            # 获取姓名
            name = re.sub(&apos;同学&apos;, &apos;&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)
            # 将姓名URL化
            xm = urllib.parse.quote(name)
            return xm
        else:
            print(&apos;登陆失败&apos;, r.url)
    except:
        print(&quot;error:登录出错&quot;)


# 获取成绩页面
def get_grade(self):
    try:
        # 获取URL化后的姓名
        name = self.login()
        # http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xscjcx.aspx?xh=201713013059&amp;xm=%D1%EE%EF%C7&amp;gnmkdm=N121605
        grade_url = &quot;{}({})/xscjcx.aspx?xh={}&amp;xm={}&amp;gnmkdm=N121605&quot;.format(self.url, self.token, self.user,
                                                                           name)  # 生成URL
        header = {
            &quot;Referer&quot;: grade_url,  # Referer必须有
            &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36&quot;
        }  # 生成header
        r = requests.get(grade_url, headers=header)
        r.encoding = r.apparent_encoding
        &quot;&quot;&quot;
        r = requests.get(&quot;{}/{}/xscjcx.aspx?{}&quot;.format(self.url, self.token, urllib.parse.urlencode({
            &apos;xh&apos;: self.user,
            &apos;xm&apos;: info\[2\],
            &apos;gnmkdm&apos;: &apos;N121603&apos;
        })))
        &quot;&quot;&quot;
        soup = BeautifulSoup(r.text, &apos;lxml&apos;)
        # 获取表单信息
        \_\_EVENTTARGET = soup.select\_one(&apos;input\[name=&quot;__EVENTTARGET&quot;\]&apos;).get(&quot;value&quot;)
        \_\_EVENTARGUMENT = soup.select\_one(&apos;input\[name=&quot;__EVENTARGUMENT&quot;\]&apos;).get(&quot;value&quot;)
        new\_\_VIEWSTATE = soup.select\_one(&apos;input\[name=&quot;__VIEWSTATE&quot;\]&apos;).get(&quot;value&quot;)
        grade_data = {
            &quot;\_\_EVENTTARGET&quot;: \_\_EVENTTARGET,
            &quot;\_\_EVENTARGUMENT&quot;: \_\_EVENTARGUMENT,
            &quot;\_\_VIEWSTATE&quot;: new\_\_VIEWSTATE,
            &quot;ddlXN&quot;: input(&quot;请输入学年(如：2017-2018):&quot;),
            &quot;ddlXQ&quot;: input(&quot;请输入学期(如：1):&quot;),
            &quot;ddl_kcxz&quot;: &quot;&quot;,
            &quot;btn_xq&quot;: urllib.parse.quote(&quot;学期成绩&quot;)
        }
        # http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xscjcx.aspx?xh=201713013059&amp;xm=%D1%EE%EF%C7&amp;gnmkdm=N121605
        grade\_html = session.post(grade\_url, headers=header, data=grade_data)
        soup\_grade = BeautifulSoup(grade\_html.text, &apos;lxml&apos;)
        title = soup_grade.select(&apos;font\[size=&quot;4&quot;\]&apos;)\[0\].text  # 标题
        xh = soup\_grade.select\_one(&apos;span#lbl_xh&apos;).text  # 学号
        xm = soup\_grade.select\_one(&apos;span#lbl_xm&apos;).text  # 姓名
        xy = soup\_grade.select\_one(&apos;span#lbl_xy&apos;).text  # 学院
        zy = &apos;专业：{}&apos;.format(soup\_grade.select\_one(&apos;span#lbl_zymc&apos;).text)  # 专业
        xzb = soup\_grade.select\_one(&apos;span#lbl_xzb&apos;).text  # 行政班
        table = soup\_grade.select\_one(&apos;table#Datagrid1&apos;).prettify()  # 成绩表
        grade_table = re.sub(&apos;&quot;datelist&quot;&apos;, &apos;&quot;mdui-table&quot;&apos;, table)
        grade = title + &quot;
</code></pre><p>“ + xh + “<br>“ + xm + “<br>“ + xy + “<br>“ + zy + “<br>“ + xzb + “<br>“ + grade_table<br>            html = ‘’’&lt;!doctype html&gt; </p>
<pre><code>&apos;&apos;&apos;.format(urllib.parse.unquote(name))
    # 将内容写入html文件
    with open(&apos;./index.html&apos;, &apos;a+&apos;) as f:
        f.truncate(0)
        f.write(html + grade)
    print(&quot;it&apos;s done!&quot;)
except:
    print(&quot;error:获取成绩单出错&quot;)
</code></pre><p>run = ZF()<br>run.get_grade() </p>
<h2 id="接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了"><a href="#接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了" class="headerlink" title="接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了"></a>接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了</h2>
      
    </div>

    

    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>支持的PY方式</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat_qcode.png" alt="BlankYK 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="BlankYK 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/24/71/" rel="next" title="Eclipse安装和汉化">
                <i class="fa fa-chevron-left"></i> Eclipse安装和汉化
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/09/240/" rel="prev" title="Linux Vi/Vim笔记">
                Linux Vi/Vim笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/head.jpg"
                alt="BlankYK" />
            
              <p class="site-author-name" itemprop="name">BlankYK</p>
              <p class="site-description motion-element" itemprop="description">世界上只有2种人，会二进制的和不会二进制的</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/idoctype" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:917885215@qq.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#本篇文章以四川航天职业技术学院教务系统为例"><span class="nav-number">1.</span> <span class="nav-text">本篇文章以四川航天职业技术学院教务系统为例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VIEWSTATE"><span class="nav-number">1.1.</span> <span class="nav-text">__VIEWSTATE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证码"><span class="nav-number">1.2.</span> <span class="nav-text">验证码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#获取验证码图片并保存至本地，再打开"><span class="nav-number"></span> <span class="nav-text">获取验证码图片并保存至本地，再打开</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模拟登陆"><span class="nav-number"></span> <span class="nav-text">模拟登陆</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#获取URL化后的姓名"><span class="nav-number"></span> <span class="nav-text">获取URL化后的姓名</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了"><span class="nav-number">1.</span> <span class="nav-text">接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-BlankYk"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">BlankYK</span>

  

  
</div>


  



  <div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Pisces</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


















  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


</body>
</html>
