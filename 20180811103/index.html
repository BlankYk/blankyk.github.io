<!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet"><link href="/css/main.css?v=6.4.1" rel="stylesheet"><link rel="apple-touch-icon" sizes="180x180" href="http://cloud.css0209.cn/css0209img/logo.png?v=6.4.1"><link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png?v=6.4.1"><link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png?v=6.4.1"><link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.4.1",sidebar:{position:"left",display:"always",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"bounceRightIn",post_header:"bounceRightIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideLeftIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="本篇文章以我所用教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：Github-zhengfang 首先观察学校官网的地址：  原本的地址是 https://220.167.53.63:95/ 然后变成 https://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx 首先端口使用的95端口，95"><meta name="keywords" content="BlankYk,四川航天学院"><meta property="og:type" content="article"><meta property="og:title" content="Python3 正方爬虫"><meta property="og:url" content="https://css0209.cn/20180811103/index.html"><meta property="og:site_name" content="BlankYk"><meta property="og:description" content="本篇文章以我所用教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：Github-zhengfang 首先观察学校官网的地址：  原本的地址是 https://220.167.53.63:95/ 然后变成 https://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx 首先端口使用的95端口，95"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:image" content="https://css0209.cn/images/loading1.gif"><meta property="og:updated_time" content="2018-12-05T07:36:46.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Python3 正方爬虫"><meta name="twitter:description" content="本篇文章以我所用教务系统为例由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：Github-zhengfang 首先观察学校官网的地址：  原本的地址是 https://220.167.53.63:95/ 然后变成 https://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx 首先端口使用的95端口，95"><meta name="twitter:image" content="https://css0209.cn/images/loading1.gif"><link rel="alternate" href="/atom.xml" title="BlankYk" type="application/atom+xml"><link rel="canonical" href="https://css0209.cn/20180811103/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Python3 正方爬虫 | BlankYk</title><meta name="google-site-verification" content="kAjz9Ic_7Hir1rNUQtXSxTydJTryAv8JMelb2Qvnges"><link rel="stylesheet" href="//cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css"><script src="//cdnjs.loli.net/ajax/libs/mdui/0.4.1/js/mdui.min.js"></script><script src="/js/src/crash_cheat.js"></script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><a href="https://github.com/idoctype" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;z-index:10;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">BlankYk</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">Blog</h1></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/aboutme/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>时间线</a></li><li class="menu-item menu-item-本站的404"><a href="/404.html" rel="section"><i class="menu-item-icon fa fa-fw fa-exclamation-triangle"></i><br>本站的404</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://css0209.cn/20180811103/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="BlankYK"><meta itemprop="description" content="相信明天更加美好"><meta itemprop="image" content="/images/head.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="BlankYk"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Python3 正方爬虫</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-08-11 19:52:13" itemprop="dateCreated datePublished" datetime="2018-08-11T19:52:13+08:00">2018-08-11</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2018-12-05 15:36:46" itemprop="dateModified" datetime="2018-12-05T15:36:46+08:00">2018-12-05</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/20180811103/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/20180811103/" itemprop="commentCount"></span></a></span><div class="post-symbolscount"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">16k</span></div></div></header><div class="post-body" itemprop="articleBody"><h1 id="本篇文章以我所用教务系统为例"><a href="#本篇文章以我所用教务系统为例" class="headerlink" title="本篇文章以我所用教务系统为例"></a>本篇文章以我所用教务系统为例</h1><p>由于学校把课表关闭了，所以我现在先爬取的成绩查询 本项目的完整代码地址：<a href="https://github.com/idoctype/zhengfang" target="_blank" rel="noopener">Github-zhengfang</a> 首先观察学校官网的地址： <a href="https://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg" target="_blank" rel="noopener"><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/Xnip2018-08-12_19-57-19.jpg" alt=""></a>原本的地址是 <a href="https://220.167.53.63:95/" target="_blank" rel="noopener">https://220.167.53.63:95/</a> 然后变成 <a href="https://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx" target="_blank" rel="noopener">https://220.167.53.63:95/(4eggunep4b4jhzfwhk4pva21)/default2.aspx</a> 首先端口使用的95端口，95端口是非安全端口，现在的主流浏览器应该是无法访问的，这里我只提供要用到的Chrome的Mac版的解决方案,具体可以参考我的文章 <a href="https://css0209.cn/2018/09/10/251/">Chrome/Firefox非安全端口问题</a> 打开终端复制以下命令，最后的<code>--explicitly-allowed-ports=95</code>中的95就是你想打开的非安全端口号</p><p>/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome –explicitly-allowed-ports=95</p><p>然后是<code>(4eggunep4b4jhzfwhk4pva21)</code>中间的这窜数字，刷新几次后发现这个是会变的，也就是不确定的 default2.aspx是登录页面 再来看看NetWork的信息 <a href="https://cloud.css0209.cn/2018/08/8FF2E09F-E9C7-44AC-980E-204355B34118.jpg" target="_blank" rel="noopener"><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/8FF2E09F-E9C7-44AC-980E-204355B34118.jpg" alt=""></a>在我们访问<a href="https://220.167.53.63:95/时进行了以个302跳转，那么在302跳转之前是个什么东西呢？" target="_blank" rel="noopener">https://220.167.53.63:95/时进行了以个302跳转，那么在302跳转之前是个什么东西呢？</a> 我用Burp Suite Professional抓包工具来看看： <a href="https://cloud.css0209.cn/2018/08/F138B3AB-E6F8-4FFA-92F5-29F5C9744776.jpg" target="_blank" rel="noopener"><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/F138B3AB-E6F8-4FFA-92F5-29F5C9744776.jpg" alt=""></a>得到上图中的信息然后我们可以发现<code>(bfpyl355aa3owdf50bdgfg55)</code>正好是我们需要的那段随机生成的值，也就是说，我们可以通过先爬取这个页面中的内容获得这个值，我们将这个值命名为token，然后代码如下： （由于这个博客的编辑器比较皮，所以格式可能有点不对，没法输制表符）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-*- coding: UTF<span class="number">-8</span> -*-</span><br><span class="line">    <span class="keyword">import</span> urllib.parse</span><br><span class="line">    <span class="keyword">import</span> requests</span><br><span class="line">    <span class="keyword">import</span> re</span><br><span class="line">    <span class="keyword">import</span> PIL</span><br><span class="line">    <span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line">    <span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">    session = requests.Session() <span class="comment"># 初始化session</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ZF</span>:</span></span><br><span class="line">     初始化</span><br><span class="line">         <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">               self.url = <span class="string">'https://220.167.53.63:95/'</span> <span class="comment"># 链接</span></span><br><span class="line">               s = session.get(<span class="string">'&#123;&#125;default2.aspx'</span>.format(self.url),allow_redirects=<span class="keyword">False</span>) <span class="comment"># allow_redirects:重定向；会话，get方法获取页面，防止302重定向</span></span><br><span class="line">               pattern = re.compile(<span class="string">"href='/\((\w*)\)"</span>) <span class="comment"># 正则表达式</span></span><br><span class="line">               token = pattern.findall(s.text) <span class="comment"># 查询页面中信息，匹配正则表达式并保存到列表token</span></span><br><span class="line">               self.token = token[<span class="number">0</span>] <span class="comment"># 取出列表中的token,并赋值</span></span><br><span class="line">               self.index_url = <span class="string">"https://220.167.53.63:95/(&#123;&#125;)/default2.aspx"</span>.format(self.token) <span class="comment"># 定义主页地址</span></span><br></pre></td></tr></table></figure><p>接下来我们登录观察并获取信息：<a href="https://www.css0209.cn/wp-content/uploads/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618-300x169.jpg" target="_blank" rel="noopener"></a> <a href="https://cloud.css0209.cn/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618-300x169.jpg" target="_blank" rel="noopener"><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/9F85AC9C-3E51-4AB2-B82A-0288A1C7A618.jpg" alt=""></a>通过观察发现url地址的<code>defult2.aspx</code>变成了<code>xs_main.aspx?xh=[学号]</code> 提交的表单信息中有6个值</p><h1 id="VIEWSTATE"><a href="#VIEWSTATE" class="headerlink" title="__VIEWSTATE"></a>__VIEWSTATE</h1><p>不知道是什么东西，但是会变，猜测和<code>csrf</code>类似</p><table><thead><tr><th>值</th><th>内容</th></tr></thead><tbody><tr><td>TextBox1</td><td>学号</td></tr><tr><td>TextBox2</td><td>密码</td></tr><tr><td>TextBox3</td><td>验证码</td></tr><tr><td>RadioButtonList1</td><td>登录页面学生的那个选框</td></tr><tr><td>Button1</td><td>永远都是空白</td></tr></tbody></table><p>学号，密码，可以通过用户输入得到 <code>Button1</code>,和<code>RadioButtonList1</code>的值是固定的，而且<code>RadioButtonList1</code>如果在表单中不存在就会默认为学生选项 也就是说我们只需要解决验证码和<code>__VIEWSTATE</code>的值</p><p>回到登录页面观察form表单<a href="https://cloud.css0209.cn/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145-300x163.jpg" target="_blank" rel="noopener"></a> <a href="https://cloud.css0209.cn/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145-300x163.jpg" target="_blank" rel="noopener"><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/BD67EEAA-9F8A-4362-B9D2-9C34CB854145.jpg" alt=""></a>很快便可以发现在form标签后面紧跟了一个input标签里面的value就是我们要的__VIEWSTATE的值 那么代码如下:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: UTF-8 -*-</span><br><span class="line">import urllib.parse</span><br><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import PIL</span><br><span class="line">from PIL import Image</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line"></span><br><span class="line">session = requests.Session()  # 初始化session</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ZF:</span><br><span class="line">    # 初始化</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.url = &apos;http://220.167.53.63:95/&apos;  # 链接</span><br><span class="line">        s = session.get(&apos;&#123;&#125;default2.aspx&apos;.format(self.url),</span><br><span class="line">                        allow_redirects=False)  # allow_redirects:重定向；会话，get方法获取页面，防止302重定向</span><br><span class="line">        pattern = re.compile(&quot;href=&apos;/\((\w*)\)&quot;)  # 正则表达式</span><br><span class="line">        token = pattern.findall(s.text)  # 查询页面中信息，匹配正则表达式并保存到列表token</span><br><span class="line">        self.token = token[0]  # 取出列表中的token,并赋值</span><br><span class="line">        self.index_url = &quot;http://220.167.53.63:95/(&#123;&#125;)/default2.aspx&quot;.format(self.token)  # 定义主页地址</span><br><span class="line">        # requests过去页面信息</span><br><span class="line">        r = requests.get(self.index_url)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        # beautifulsoup格式化内容，用lxml解析</span><br><span class="line">        soup = BeautifulSoup(r.text, &apos;lxml&apos;)</span><br><span class="line">        # 从页面中获取__VIEWSTATE</span><br><span class="line">        self.__VIEWSTATE = soup.select_one(&apos;input[name=&quot;__VIEWSTATE&quot;]&apos;).get(&quot;value&quot;)</span><br><span class="line">        # 学号和密码</span><br><span class="line">        # self.user = &apos;&apos;</span><br><span class="line">        # self.pwd = &apos;&apos;</span><br><span class="line">        self.user = input(&quot;请输入学号：&quot;)</span><br><span class="line">        self.pwd = input(&quot;请输入密码：&quot;)</span><br></pre></td></tr></table></figure><p></p><h1 id="验证码"><a href="#验证码" class="headerlink" title="验证码"></a>验证码</h1><p>验证码获取很简单: 直接鼠标右键复制图片链接，复制下来会发现就是<code>default2.aspx</code>变成了<code>CheckCode.aspx</code> <img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/F0696265-FDA9-49E9-A2EA-D9B041B8687E.jpg" alt=""> 那么我们只需要把验证码以二进制的形式下载下来，需要的时候调用，能打开显示就行 代码如下:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 获取验证码图片并保存至本地，再打开</span><br><span class="line">    def captchas(self):</span><br><span class="line">        try:</span><br><span class="line">            url = &quot;https://220.167.53.63:95/(&#123;&#125;)/CheckCode.aspx&quot;.format(self.token)  # 验证码图片地址</span><br><span class="line">            img_r = requests.get(url)  # 获取验证码图片</span><br><span class="line">            # 以二进制保存至本地</span><br><span class="line">            with open(&apos;./img/captcha.jpg&apos;, &apos;wb&apos;) as f:</span><br><span class="line">                f.write(img_r.content)</span><br><span class="line">            # 利用PIL打开图片</span><br><span class="line">            PIL.Image.open(&apos;./img/captcha.jpg&apos;).show()</span><br><span class="line">            # 让用户输入验证码</span><br><span class="line">            return input(&quot;请输入验证码：&quot;)</span><br><span class="line">        except:</span><br><span class="line">            print(&quot;error:获取验证码失败&quot;)</span><br></pre></td></tr></table></figure><p></p><p>获取了需要的信息，我们就可以进行模拟登陆了，这里我们登录后获取一下用户姓名并URL化，后面会用到:</p><h1 id="模拟登陆"><a href="#模拟登陆" class="headerlink" title="模拟登陆"></a>模拟登陆</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">def login(self):</span><br><span class="line">    # http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xs_main.aspx?xh=201713013059</span><br><span class="line">    try:</span><br><span class="line"></span><br><span class="line">        url = &quot;http://220.167.53.63:95/(&#123;&#125;)/default2.aspx&quot;.format(self.token)  # 生成登陆地址</span><br><span class="line">        # 用字典保存data</span><br><span class="line">        data = &#123;</span><br><span class="line">            &apos;__VIEWSTATE&apos;: self.__VIEWSTATE,</span><br><span class="line">            &apos;TextBox1&apos;: self.user,</span><br><span class="line">            &apos;TextBox2&apos;: self.pwd,</span><br><span class="line">            &apos;TextBox3&apos;: self.captchas(),</span><br><span class="line">            &apos;Button1&apos;: &apos;&apos;</span><br><span class="line">        &#125;</span><br><span class="line">        r = session.post(url, data=data)</span><br><span class="line">        r.encoding = r.apparent_encoding  # 修改编码为网页编码</span><br><span class="line">        # 检查提交后URL中是否含有&apos;xs_main.aspx?xh=&apos;，如果有就表示登陆成功</span><br><span class="line">        if &apos;xs_main.aspx?xh=&apos; in r.url:</span><br><span class="line">            soup = BeautifulSoup(r.text, &apos;lxml&apos;)</span><br><span class="line">            print(&apos;登陆成功\n欢迎您：&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)</span><br><span class="line">            # 获取姓名</span><br><span class="line">            name = re.sub(&apos;同学&apos;, &apos;&apos;, soup.select_one(&apos;.info span#xhxm&apos;).text)</span><br><span class="line">            # 将姓名URL化</span><br><span class="line">            xm = urllib.parse.quote(name)</span><br><span class="line">            return xm</span><br><span class="line">        else:</span><br><span class="line">            print(&apos;登陆失败&apos;, r.url)</span><br><span class="line">    except:</span><br><span class="line">        print(&quot;error:登录出错&quot;)</span><br></pre></td></tr></table></figure><p>接下来进行一次查询操作 <img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/QQ20180812-183454.png" alt=""><br>可以看到这个东西<br><code>https://220.167.53.63:95/(xg1yk155oifue555urpnb0ng)/xscjcx.aspx?xh=\[学号\]&amp;xm=\[URL化的姓名\]&amp;gnmkdm=N121605</code><br>这个地址是声明我们从哪里来的，我们可以由拼接生成<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># 获取URL化后的姓名</span></span><br><span class="line">            name = self.login()<span class="comment">#这里是刚刚获取的URL话的名字</span></span><br><span class="line">            grade_url = <span class="string">"&#123;&#125;(&#123;&#125;)/xscjcx.aspx?xh=&#123;&#125;&amp;xm=&#123;&#125;&amp;gnmkdm=N121605"</span>.format(self.url, self.token, self.user, name)  <span class="comment"># 生成URL </span></span><br><span class="line"></span><br><span class="line">我们要把这个写入headers，这里要注意的是这个headers里Referer是一定要有的</span><br><span class="line"></span><br><span class="line">    header = &#123;</span><br><span class="line">                    <span class="string">"Referer"</span>: grade_url,  <span class="comment"># Referer必须有</span></span><br><span class="line">                    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36"</span></span><br><span class="line">                &#125;  <span class="comment"># 生成header</span></span><br></pre></td></tr></table></figure><p></p><p>再来看下我们提交的东西 <img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/QQ20180812-183734.png" alt=""><br>这一看，妈哟！这么长的什么东西！？ 不要慌，回到之前页面看看 从表单那可以看到这么些东西<br><img src="/images/loading1.gif" data-original="https://cloud.css0209.cn/2018/08/QQ20180812-204015.png" alt=""> 可以发现这些值就是我们需要的，那么爬取下来即可<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">r = requests.get(grade_url, headers=header)</span><br><span class="line">            r.encoding = r.apparent_encoding</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            r = requests.get("&#123;&#125;/&#123;&#125;/xscjcx.aspx?&#123;&#125;".format(self.url, self.token, urllib.parse.urlencode(&#123;</span></span><br><span class="line"><span class="string">                'xh': self.user,</span></span><br><span class="line"><span class="string">                'xm': info[2],</span></span><br><span class="line"><span class="string">                'gnmkdm': 'N121603'</span></span><br><span class="line"><span class="string">            &#125;)))</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            soup = BeautifulSoup(r.text, <span class="string">'lxml'</span>)</span><br><span class="line">            <span class="comment"># 获取表单信息</span></span><br><span class="line">            __EVENTTARGET = soup.select_one(<span class="string">'input[name="__EVENTTARGET"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">            __EVENTARGUMENT = soup.select_one(<span class="string">'input[name="__EVENTARGUMENT"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">            new__VIEWSTATE = soup.select_one(<span class="string">'input[name="__VIEWSTATE"]'</span>).get(<span class="string">"value"</span>)</span><br></pre></td></tr></table></figure><p></p><table><thead><tr><th>值</th><th>对应的value</th></tr></thead><tbody><tr><td>那么还有4个值</td><td>ddlXN</td></tr><tr><td>表单中的学年</td><td>ddlXQ</td></tr><tr><td>表单中的学期</td><td>ddl_kcxz</td></tr><tr><td>表单中的课程性质</td><td>btn_xq</td></tr></tbody></table><p>点击的哪个按钮，这里我默认用学期成绩按钮</p><p>这里的<code>ddlXN</code>和<code>ddlXQ</code>我们让用户来输入 <code>ddl_kcxz</code>设为空和<code>btn_xq</code>为URL化的“学期成绩” 把表单信息存入data<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">grade_data = &#123;</span><br><span class="line">               <span class="string">"__EVENTTARGET"</span>: __EVENTTARGET,</span><br><span class="line">               <span class="string">"__EVENTARGUMENT"</span>: __EVENTARGUMENT,</span><br><span class="line">               <span class="string">"__VIEWSTATE"</span>: new__VIEWSTATE,</span><br><span class="line">               <span class="string">"ddlXN"</span>: input(<span class="string">"请输入学年(如：2017-2018):"</span>),</span><br><span class="line">               <span class="string">"ddlXQ"</span>: input(<span class="string">"请输入学期(如：1):"</span>),</span><br><span class="line">               <span class="string">"ddl_kcxz"</span>: <span class="string">""</span>,</span><br><span class="line">               <span class="string">"btn_xq"</span>: urllib.parse.quote(<span class="string">"学期成绩"</span>)</span><br><span class="line">           &#125;</span><br></pre></td></tr></table></figure><p></p><p>有了信息后我们进行访问，会获得一些信息,然后我们将这些信息提取出来,然后写入HTML文档里<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">        grade_html = session.post(grade_url, headers=header, data=grade_data)</span><br><span class="line">        soup_grade = BeautifulSoup(grade_html.text, <span class="string">'lxml'</span>)</span><br><span class="line">        title = soup_grade.select(<span class="string">'font[size="4"]'</span>)[<span class="number">0</span>].text  <span class="comment"># 标题</span></span><br><span class="line">        xh = soup_grade.select_one(<span class="string">'span#lbl_xh'</span>).text  <span class="comment"># 学号</span></span><br><span class="line">        xm = soup_grade.select_one(<span class="string">'span#lbl_xm'</span>).text  <span class="comment"># 姓名</span></span><br><span class="line">        xy = soup_grade.select_one(<span class="string">'span#lbl_xy'</span>).text  <span class="comment"># 学院</span></span><br><span class="line">        zy = <span class="string">'专业：&#123;&#125;'</span>.format(soup_grade.select_one(<span class="string">'span#lbl_zymc'</span>).text)  <span class="comment"># 专业</span></span><br><span class="line">        xzb = soup_grade.select_one(<span class="string">'span#lbl_xzb'</span>).text  <span class="comment"># 行政班</span></span><br><span class="line">        table = soup_grade.select_one(<span class="string">'table#Datagrid1'</span>).prettify()  <span class="comment"># 成绩表</span></span><br><span class="line">        grade_table = re.sub(<span class="string">'"datelist"'</span>, <span class="string">'"mdui-table"'</span>, table)</span><br><span class="line">        grade = title + <span class="string">"&lt;br/&gt;"</span> + xh + <span class="string">"&lt;br/&gt;"</span> + xm + <span class="string">"&lt;br/&gt;"</span> + xy + <span class="string">"&lt;br/&gt;"</span> + zy + <span class="string">"&lt;br/&gt;"</span> + xzb + <span class="string">"&lt;br/&gt;"</span> + grade_table</span><br><span class="line">        html = <span class="string">'''&lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang="zh-cn"&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name="viewport"</span></span><br><span class="line"><span class="string">          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"&gt;</span></span><br><span class="line"><span class="string">    &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;&#123;&#125;同学的成绩单&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;link rel="stylesheet" href="http://cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css"&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">        '''</span>.format(urllib.parse.unquote(name))</span><br><span class="line">        <span class="comment"># 将内容写入html文件</span></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'./index.html'</span>, <span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.truncate(<span class="number">0</span>)</span><br><span class="line">            f.write(html + grade)</span><br><span class="line">        print(<span class="string">"it's done!"</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"error:获取成绩单出错"</span>)</span><br></pre></td></tr></table></figure><p></p><p>最后，来看一下整体代码<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> PIL</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">session = requests.Session()  <span class="comment"># 初始化session</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZF</span>:</span></span><br><span class="line">    <span class="comment"># 初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.url = <span class="string">'http://220.167.53.63:95/'</span>  <span class="comment"># 链接</span></span><br><span class="line">        s = session.get(<span class="string">'&#123;&#125;default2.aspx'</span>.format(self.url),</span><br><span class="line">                        allow_redirects=<span class="keyword">False</span>)  <span class="comment"># allow_redirects:重定向；会话，get方法获取页面，防止302重定向</span></span><br><span class="line">        pattern = re.compile(<span class="string">"href='/\((\w*)\)"</span>)  <span class="comment"># 正则表达式</span></span><br><span class="line">        token = pattern.findall(s.text)  <span class="comment"># 查询页面中信息，匹配正则表达式并保存到列表token</span></span><br><span class="line">        self.token = token[<span class="number">0</span>]  <span class="comment"># 取出列表中的token,并赋值</span></span><br><span class="line">        self.index_url = <span class="string">"http://220.167.53.63:95/(&#123;&#125;)/default2.aspx"</span>.format(self.token)  <span class="comment"># 定义主页地址</span></span><br><span class="line">        <span class="comment"># requests过去页面信息</span></span><br><span class="line">        r = requests.get(self.index_url)</span><br><span class="line">        r.encoding = r.apparent_encoding</span><br><span class="line">        <span class="comment"># beautifulsoup格式化内容，用lxml解析</span></span><br><span class="line">        soup = BeautifulSoup(r.text, <span class="string">'lxml'</span>)</span><br><span class="line">        <span class="comment"># 从页面中获取__VIEWSTATE</span></span><br><span class="line">        self.__VIEWSTATE = soup.select_one(<span class="string">'input[name="__VIEWSTATE"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">        <span class="comment"># 学号和密码</span></span><br><span class="line">        <span class="comment"># self.user = ''</span></span><br><span class="line">        <span class="comment"># self.pwd = ''</span></span><br><span class="line">        self.user = input(<span class="string">"请输入学号："</span>)</span><br><span class="line">        self.pwd = input(<span class="string">"请输入密码："</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取验证码图片并保存至本地，再打开</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">captchas</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = <span class="string">"http://220.167.53.63:95/(&#123;&#125;)/CheckCode.aspx"</span>.format(self.token)  <span class="comment"># 验证码图片地址</span></span><br><span class="line">            img_r = requests.get(url)  <span class="comment"># 获取验证码图片</span></span><br><span class="line">            <span class="comment"># 以二进制保存至本地</span></span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'./img/captcha.jpg'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(img_r.content)</span><br><span class="line">            <span class="comment"># 利用PIL打开图片</span></span><br><span class="line">            PIL.Image.open(<span class="string">'./img/captcha.jpg'</span>).show()</span><br><span class="line">            <span class="comment"># 让用户输入验证码</span></span><br><span class="line">            <span class="keyword">return</span> input(<span class="string">"请输入验证码："</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"error:获取验证码失败"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 模拟登陆</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xs_main.aspx?xh=201713013059</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">            url = <span class="string">"http://220.167.53.63:95/(&#123;&#125;)/default2.aspx"</span>.format(self.token)  <span class="comment"># 生成登陆地址</span></span><br><span class="line">            <span class="comment"># 用字典保存data</span></span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">'__VIEWSTATE'</span>: self.__VIEWSTATE,</span><br><span class="line">                <span class="string">'TextBox1'</span>: self.user,</span><br><span class="line">                <span class="string">'TextBox2'</span>: self.pwd,</span><br><span class="line">                <span class="string">'TextBox3'</span>: self.captchas(),</span><br><span class="line">                <span class="string">'Button1'</span>: <span class="string">''</span></span><br><span class="line">            &#125;</span><br><span class="line">            r = session.post(url, data=data)</span><br><span class="line">            r.encoding = r.apparent_encoding  <span class="comment"># 修改编码为网页编码</span></span><br><span class="line">            <span class="comment"># 检查提交后URL中是否含有'xs_main.aspx?xh='，如果有就表示登陆成功</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'xs_main.aspx?xh='</span> <span class="keyword">in</span> r.url:</span><br><span class="line">                soup = BeautifulSoup(r.text, <span class="string">'lxml'</span>)</span><br><span class="line">                print(<span class="string">'登陆成功\n欢迎您：'</span>, soup.select_one(<span class="string">'.info span#xhxm'</span>).text)</span><br><span class="line">                <span class="comment"># 获取姓名</span></span><br><span class="line">                name = re.sub(<span class="string">'同学'</span>, <span class="string">''</span>, soup.select_one(<span class="string">'.info span#xhxm'</span>).text)</span><br><span class="line">                <span class="comment"># 将姓名URL化</span></span><br><span class="line">                xm = urllib.parse.quote(name)</span><br><span class="line">                <span class="keyword">return</span> xm</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'登陆失败'</span>, r.url)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"error:登录出错"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 获取成绩页面</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_grade</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 获取URL化后的姓名</span></span><br><span class="line">            name = self.login()</span><br><span class="line">            <span class="comment"># http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xscjcx.aspx?xh=201713013059&amp;xm=%D1%EE%EF%C7&amp;gnmkdm=N121605</span></span><br><span class="line">            grade_url = <span class="string">"&#123;&#125;(&#123;&#125;)/xscjcx.aspx?xh=&#123;&#125;&amp;xm=&#123;&#125;&amp;gnmkdm=N121605"</span>.format(self.url, self.token, self.user,</span><br><span class="line">                                                                               name)  <span class="comment"># 生成URL</span></span><br><span class="line">            header = &#123;</span><br><span class="line">                <span class="string">"Referer"</span>: grade_url,  <span class="comment"># Referer必须有</span></span><br><span class="line">                <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.110 Safari/537.36"</span></span><br><span class="line">            &#125;  <span class="comment"># 生成header</span></span><br><span class="line">            r = requests.get(grade_url, headers=header)</span><br><span class="line">            r.encoding = r.apparent_encoding</span><br><span class="line">            <span class="string">"""</span></span><br><span class="line"><span class="string">            r = requests.get("&#123;&#125;/&#123;&#125;/xscjcx.aspx?&#123;&#125;".format(self.url, self.token, urllib.parse.urlencode(&#123;</span></span><br><span class="line"><span class="string">                'xh': self.user,</span></span><br><span class="line"><span class="string">                'xm': info[2],</span></span><br><span class="line"><span class="string">                'gnmkdm': 'N121603'</span></span><br><span class="line"><span class="string">            &#125;)))</span></span><br><span class="line"><span class="string">            """</span></span><br><span class="line">            soup = BeautifulSoup(r.text, <span class="string">'lxml'</span>)</span><br><span class="line">            <span class="comment"># 获取表单信息</span></span><br><span class="line">            __EVENTTARGET = soup.select_one(<span class="string">'input[name="__EVENTTARGET"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">            __EVENTARGUMENT = soup.select_one(<span class="string">'input[name="__EVENTARGUMENT"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">            new__VIEWSTATE = soup.select_one(<span class="string">'input[name="__VIEWSTATE"]'</span>).get(<span class="string">"value"</span>)</span><br><span class="line">            grade_data = &#123;</span><br><span class="line">                <span class="string">"__EVENTTARGET"</span>: __EVENTTARGET,</span><br><span class="line">                <span class="string">"__EVENTARGUMENT"</span>: __EVENTARGUMENT,</span><br><span class="line">                <span class="string">"__VIEWSTATE"</span>: new__VIEWSTATE,</span><br><span class="line">                <span class="string">"ddlXN"</span>: input(<span class="string">"请输入学年(如：2017-2018):"</span>),</span><br><span class="line">                <span class="string">"ddlXQ"</span>: input(<span class="string">"请输入学期(如：1):"</span>),</span><br><span class="line">                <span class="string">"ddl_kcxz"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"btn_xq"</span>: urllib.parse.quote(<span class="string">"学期成绩"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment"># http://220.167.53.63:95/(2gfd5m3bax5l2rigc0yfiofq)/xscjcx.aspx?xh=201713013059&amp;xm=%D1%EE%EF%C7&amp;gnmkdm=N121605</span></span><br><span class="line">            grade_html = session.post(grade_url, headers=header, data=grade_data)</span><br><span class="line">            soup_grade = BeautifulSoup(grade_html.text, <span class="string">'lxml'</span>)</span><br><span class="line">            title = soup_grade.select(<span class="string">'font[size="4"]'</span>)[<span class="number">0</span>].text  <span class="comment"># 标题</span></span><br><span class="line">            xh = soup_grade.select_one(<span class="string">'span#lbl_xh'</span>).text  <span class="comment"># 学号</span></span><br><span class="line">            xm = soup_grade.select_one(<span class="string">'span#lbl_xm'</span>).text  <span class="comment"># 姓名</span></span><br><span class="line">            xy = soup_grade.select_one(<span class="string">'span#lbl_xy'</span>).text  <span class="comment"># 学院</span></span><br><span class="line">            zy = <span class="string">'专业：&#123;&#125;'</span>.format(soup_grade.select_one(<span class="string">'span#lbl_zymc'</span>).text)  <span class="comment"># 专业</span></span><br><span class="line">            xzb = soup_grade.select_one(<span class="string">'span#lbl_xzb'</span>).text  <span class="comment"># 行政班</span></span><br><span class="line">            table = soup_grade.select_one(<span class="string">'table#Datagrid1'</span>).prettify()  <span class="comment"># 成绩表</span></span><br><span class="line">            grade_table = re.sub(<span class="string">'"datelist"'</span>, <span class="string">'"mdui-table"'</span>, table)</span><br><span class="line">            grade = title + <span class="string">"&lt;br/&gt;"</span> + xh + <span class="string">"&lt;br/&gt;"</span> + xm + <span class="string">"&lt;br/&gt;"</span> + xy + <span class="string">"&lt;br/&gt;"</span> + zy + <span class="string">"&lt;br/&gt;"</span> + xzb + <span class="string">"&lt;br/&gt;"</span> + grade_table</span><br><span class="line">            html = <span class="string">'''&lt;!doctype html&gt;</span></span><br><span class="line"><span class="string">    &lt;html lang="zh-cn"&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="string">        &lt;meta name="viewport"</span></span><br><span class="line"><span class="string">              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"&gt;</span></span><br><span class="line"><span class="string">        &lt;meta http-equiv="X-UA-Compatible" content="ie=edge"&gt;</span></span><br><span class="line"><span class="string">        &lt;title&gt;&#123;&#125;同学的成绩单&lt;/title&gt;</span></span><br><span class="line"><span class="string">        &lt;link rel="stylesheet" href="http://cdnjs.loli.net/ajax/libs/mdui/0.4.1/css/mdui.min.css"&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">            '''</span>.format(urllib.parse.unquote(name))</span><br><span class="line">            <span class="comment"># 将内容写入html文件</span></span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">'./index.html'</span>, <span class="string">'a+'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.truncate(<span class="number">0</span>)</span><br><span class="line">                f.write(html + grade)</span><br><span class="line">            print(<span class="string">"it's done!"</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"error:获取成绩单出错"</span>)</span><br><span class="line">            </span><br><span class="line">           </span><br><span class="line"></span><br><span class="line">run = ZF()</span><br><span class="line">run.get_grade()</span><br></pre></td></tr></table></figure><p></p><p>接下来，我想把这个用Django写成web端，但是验证码哪里给卡着了</p></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>支持我就赏点小钱钱吧~</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechat_qcode.png" alt="BlankYK 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/alipay.jpg" alt="BlankYK 支付宝"><p>支付宝</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> BlankYK</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="103.html" title="Python3 正方爬虫">103.html</a></li><li class="post-copyright-license"><strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018032471/" rel="next" title="Eclipse安装和汉化"><i class="fa fa-chevron-left"></i> Eclipse安装和汉化</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/20180909240/" rel="prev" title="Linux Vi/Vim笔记">Linux Vi/Vim笔记<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="BlankYK"><p class="site-author-name" itemprop="name">BlankYK</p><p class="site-description motion-element" itemprop="description">相信明天更加美好</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">17</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a><a href="https://css0209.cn/sitemap.xml" rel="alternate"><i class="fa fa-sitemap"></i> sitemap</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/idoctype" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:917885215@qq.com" target="_blank" title="E-Mail" rel="external nofollow"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://space.bilibili.com/10061915/#/" target="_blank" title="Bilibili" rel="external nofollow"><i class="fa fa-fw fa-tv"></i> Bilibili</a></span><span class="links-of-author-item"><a href="https://bitbucket.org/blankyk/" target="_blank" title="Bitbucket" rel="external nofollow"><i class="fa fa-fw fa-bitbucket"></i> Bitbucket</a></span><span class="links-of-author-item"><a href="https://music.163.com/#/user/home?id=311066699" target="_blank" title="Music163" rel="external nofollow"><i class="fa fa-fw fa-music"></i> Music163</a></span><span class="links-of-author-item"><a href="http://s.team/p/khn-cnmp/KBHFMFJN" target="_blank" title="Steam" rel="external nofollow"><i class="fa fa-fw fa-steam"></i> Steam</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-block"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-link"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://haowei.ch/" title="Bamboo Sticks" target="_blank">Bamboo Sticks</a></li><li class="links-of-blogroll-item"><a href="https://blog.iucode.cn/" title="IUblog" target="_blank">IUblog</a></li><li class="links-of-blogroll-item"><a href="https://blackyau.cc/" title="蠢黑通行" target="_blank">蠢黑通行</a></li><li class="links-of-blogroll-item"><a href="http://blog.sacst.cn/" title="计算机科技协会" target="_blank">计算机科技协会</a></li></ul></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#本篇文章以我所用教务系统为例"><span class="nav-number">1.</span> <span class="nav-text">本篇文章以我所用教务系统为例</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#VIEWSTATE"><span class="nav-number">2.</span> <span class="nav-text">__VIEWSTATE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#验证码"><span class="nav-number">3.</span> <span class="nav-text">验证码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#模拟登陆"><span class="nav-number">4.</span> <span class="nav-text">模拟登陆</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright"><a href="http://www.miitbeian.gov.cn/" target="_blank">蜀ICP备17038940号-2</a><br>&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">BlankYK</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">63k</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.8.0</div><span class="post-meta-divider">|</span><div class="theme-info">主题 – <a class="theme-link" target="_blank" rel="external nofollow" href="https://theme-next.org">NexT.Pisces</a> v6.4.1</div><div class="busuanzi-count"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv" title="总访客量"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span><span class="site-pv" title="总访问量"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="//cdn.jsdelivr.net/jquery/2.1.3/jquery.min.js"></script><script src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.min.js"></script><script src="//cdn.jsdelivr.net/velocity/1.2.3/velocity.ui.min.js"></script><script src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/js/src/utils.js?v=6.4.1"></script><script src="/js/src/motion.js?v=6.4.1"></script><script src="/js/src/affix.js?v=6.4.1"></script><script src="/js/src/schemes/pisces.js?v=6.4.1"></script><script src="/js/src/scrollspy.js?v=6.4.1"></script><script src="/js/src/post-details.js?v=6.4.1"></script><script src="/js/src/bootstrap.js?v=6.4.1"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"1qw0wI8rRU2aokRUy7A0Hzld-gzGzoHsz",appKey:"kTlur1J9v6jOExvFIlWM5jbp",placeholder:"Just go go",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><style>.copy-btn{display:inline-block;padding:6px 12px;font-size:13px;font-weight:700;line-height:20px;color:#333;white-space:nowrap;vertical-align:middle;cursor:pointer;background-color:#eee;background-image:linear-gradient(#fcfcfc,#eee);border:1px solid #d5d5d5;border-radius:3px;user-select:none;outline:0}.highlight-wrap .copy-btn{transition:opacity .3s ease-in-out;opacity:0;padding:2px 6px;position:absolute;right:4px;top:8px}.highlight-wrap .copy-btn:focus,.highlight-wrap:hover .copy-btn{opacity:1}.highlight-wrap{position:relative}</style><script>$(".highlight").each(function(t,e){var n=$("<div>").addClass("highlight-wrap");$(e).after(n),n.append($("<button>").addClass("copy-btn").append("复制").on("click",function(t){var e=$(this).parent().find(".code").find(".line").map(function(t,e){return $(e).text()}).toArray().join("\n"),n=document.createElement("textarea");document.body.appendChild(n),n.style.position="absolute",n.style.top="0px",n.style.left="0px",n.value=e,n.select(),n.focus();var o=document.execCommand("copy");document.body.removeChild(n),o?$(this).text("复制成功"):$(this).text("复制失败"),$(this).blur()})).on("mouseleave",function(t){var e=$(this).find(".copy-btn");setTimeout(function(){e.text("复制")},300)}).append(e)})</script><script src="/js/src/love.js"></script><script count="130" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script>!function(n){var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function c(){for(var t=0;t<o.length;t++)0<=(e=o[t].getBoundingClientRect()).top&&0<=e.left&&e.top<=(n.innerHeight||document.documentElement.clientHeight)&&i(o[t],function(){o.splice(t,t)});var e;console.log("trigger")}c(),n.addEventListener("scroll",function(){var t,e;t=c,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>